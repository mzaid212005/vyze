{% extends 'accounts/base.html' %}

{% block title %}Doctor Dashboard - Vyze{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-5 fw-bold gradient-text mb-2">
                            <i class="fas fa-user-md me-3"></i>
                            Welcome back, Dr. {{ user.last_name|default:user.username }}!
                        </h1>
                        <p class="lead text-muted mb-0">Monitor your patients' mental health progress and provide support</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stats-card d-inline-block">
                            <div class="stats-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="mt-2">
                                <h4 class="mb-0">{{ patients|length }}</h4>
                                <small class="text-muted">Active Patients</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="mt-3">
                    <h4 class="mb-1">{{ recent_entries|length }}</h4>
                    <p class="text-muted mb-0">Recent Entries</p>
                    <div class="progress mt-2">
                        <div class="progress-bar" style="width: 75%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="mt-3">
                    <h4 class="mb-1 text-warning">3</h4>
                    <p class="text-muted mb-0">Need Attention</p>
                    <div class="progress mt-2">
                        <div class="progress-bar bg-warning" style="width: 30%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="mt-3">
                    <h4 class="mb-1 text-success">{{ patients|length|add:-1 }}</h4>
                    <p class="text-muted mb-0">Improving</p>
                    <div class="progress mt-2">
                        <div class="progress-bar bg-success" style="width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="mt-3">
                    <h4 class="mb-1">12</h4>
                    <p class="text-muted mb-0">Notes Added</p>
                    <div class="progress mt-2">
                        <div class="progress-bar bg-info" style="width: 60%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics -->
    <div class="row mb-4">
        <div class="col-xl-8 mb-4">
            <div class="modern-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-bar text-primary me-2"></i>
                        Patient Analytics Overview
                    </h3>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm active">This Week</button>
                        <button class="btn btn-outline-primary btn-sm">This Month</button>
                        <button class="btn btn-outline-primary btn-sm">All Time</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container mb-4">
                            <canvas id="patientMoodChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container mb-4">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Doctor Personal Progress -->
        <div class="col-xl-4 mb-4">
            <div class="modern-card p-4">
                <h4 class="mb-3">
                    <i class="fas fa-user-md text-success me-2"></i>
                    Your Progress
                </h4>
                <div class="chart-container mb-3">
                    <canvas id="doctorProgressChart" height="200"></canvas>
                </div>
                <div class="small text-muted">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Patients helped this month:</span>
                        <span class="fw-bold">{{ patients|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Notes added:</span>
                        <span class="fw-bold">12</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Active streak:</span>
                        <span class="fw-bold">15 days</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Personal Progress Analytics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>
                        Personal Progress Overview
                    </h3>
                    <div class="btn-group">
                        <button class="btn btn-outline-success btn-sm active">7 Days</button>
                        <button class="btn btn-outline-success btn-sm">30 Days</button>
                        <button class="btn btn-outline-success btn-sm">90 Days</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <canvas id="doctorActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="chart-container">
                            <canvas id="doctorStatsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="col-xl-4">
            <div class="modern-card p-4 mb-4">
                <h4 class="mb-3">
                    <i class="fas fa-bell text-warning me-2"></i>
                    Recent Alerts
                </h4>
                <div class="space-y-3">
                    <div class="glass-card p-3 border-start border-warning border-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-warning me-3"></i>
                            <div>
                                <h6 class="mb-1">Low Mood Alert</h6>
                                <p class="small text-muted mb-0">Patient reported mood level 2</p>
                                <small class="text-muted">2 hours ago</small>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-3 border-start border-info border-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">New Journal Entry</h6>
                                <p class="small text-muted mb-0">Patient shared important insights</p>
                                <small class="text-muted">5 hours ago</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Grid -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-users text-success me-2"></i>
                        Your Patients
                    </h3>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control" placeholder="Search patients..." style="width: 250px;">
                        <a href="{% url 'assign_patient' %}" class="btn btn-primary-modern">
                            <i class="fas fa-plus me-2"></i>
                            Add Patient
                        </a>
                    </div>
                </div>

                <div class="row">
                    {% for patient in patients %}
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                        <div class="modern-card h-100">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="avatar-circle me-3">
                                        <i class="fas fa-user text-primary"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">{{ patient.username }}</h5>
                                        <small class="text-muted">Patient ID: {{ patient.patient_id }}</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    {% with recent_mood=patient.moodentry_set.first %}
                                    {% if recent_mood %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small text-muted">Latest Mood</span>
                                            <span class="badge bg-{% if recent_mood.mood <= 3 %}danger{% elif recent_mood.mood <= 7 %}warning{% else %}success{% endif %} fs-6">
                                                {{ recent_mood.mood }}/10
                                            </span>
                                        </div>
                                        <small class="text-muted">{{ recent_mood.date|date:"M d, H:i" }}</small>
                                    {% else %}
                                        <span class="text-muted small">No mood entries yet</span>
                                    {% endif %}
                                    {% endwith %}
                                </div>

                                <div class="mb-3">
                                    <div class="small text-muted mb-1">Activity</div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary" style="width: {{ patient.moodentry_set.count|add:0 }}0%"></div>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <a href="{% url 'patient_detail' patient.id %}" class="btn btn-primary-modern btn-sm flex-fill">
                                        <i class="fas fa-eye me-1"></i>
                                        View
                                    </a>
                                    <button class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-comment me-1"></i>
                                        Note
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if not patients %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Patients Yet</h4>
                    <p class="text-muted">Start by adding patients to monitor their mental health journey</p>
                    <a href="{% url 'assign_patient' %}" class="btn btn-primary-modern">
                        <i class="fas fa-plus me-2"></i>
                        Add Your First Patient
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Patient Mood Distribution Chart
    const moodCtx = document.getElementById('patientMoodChart');
    if (moodCtx) {
        new Chart(moodCtx, {
            type: 'doughnut',
            data: {
                labels: ['High (7-10)', 'Medium (4-6)', 'Low (1-3)'],
                datasets: [{
                    data: [45, 35, 20],
                    backgroundColor: [
                        '#4caf50',
                        '#ff9800',
                        '#f44336'
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    }

    // Activity Chart
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx) {
        new Chart(activityCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Patient Entries',
                    data: [8, 12, 6, 15, 10, 7, 9],
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: '#667eea',
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutBounce'
                }
            }
        });
    }

    // Doctor Progress Chart
    const doctorProgressCtx = document.getElementById('doctorProgressChart');
    if (doctorProgressCtx) {
        new Chart(doctorProgressCtx, {
            type: 'doughnut',
            data: {
                labels: ['Patients Helped', 'Notes Added', 'Active Days'],
                datasets: [{
                    data: [{{ patients|length }}, 12, 15],
                    backgroundColor: [
                        '#28a745',
                        '#17a2b8',
                        '#ffc107'
                    ],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: { size: 12 }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1500
                }
            }
        });
    }

    // Doctor Activity Chart
    const doctorActivityCtx = document.getElementById('doctorActivityChart');
    if (doctorActivityCtx) {
        new Chart(doctorActivityCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Daily Activity',
                    data: [3, 5, 4, 7, 6, 2, 4],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#28a745',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // Doctor Stats Chart
    const doctorStatsCtx = document.getElementById('doctorStatsChart');
    if (doctorStatsCtx) {
        new Chart(doctorStatsCtx, {
            type: 'radar',
            data: {
                labels: ['Patient Care', 'Documentation', 'Response Time', 'Engagement', 'Consistency'],
                datasets: [{
                    label: 'Performance',
                    data: [85, 90, 75, 88, 92],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#17a2b8',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }
});
</script>
{% endblock %}